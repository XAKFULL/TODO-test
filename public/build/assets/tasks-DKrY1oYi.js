window.openModal=function(t){document.getElementById(t).classList.remove("hidden")};window.closeModal=function(t){document.getElementById(t).classList.add("hidden")};document.addEventListener("click",function(t){const e=t.target.closest(".task-modal");if(!e)return;if(!t.target.closest(".modal-content")){const n=e.id;window.closeModal&&window.closeModal(n)}});let r=null;window.openDeleteModal=function(t,e="эту задачу"){r=t,document.getElementById("delete-task-title").textContent=`Вы уверены, что хотите удалить задачу «${e}»?`,openModal("deleteTaskModal")};document.getElementById("confirm-delete-btn")?.addEventListener("click",function(){r&&fetch(`/api/tasks/${r}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/json"}}).then(t=>{if(t.ok){const e=document.querySelector(`.task-card[data-task-id="${r}"]`);e&&e.remove();const a=document.querySelector(`#task-row-${r}`);a&&a.remove(),closeModal("deleteTaskModal"),r=null}else alert("Ошибка при удалении")}).catch(()=>{alert("Не удалось удалить задачу")})});window.openEditModal=function(t){fetch(`/api/tasks/${t}`).then(e=>e.json()).then(e=>{const a=e.data||e;document.getElementById("edit-task-id").value=a.id,document.getElementById("edit-task-title").value=a.title||"",document.getElementById("edit-task-description").value=a.description||"",document.getElementById("edit-task-status").value=a.status_code||"pending";const n=document.getElementById("edit-tags-container");n.innerHTML="";const o=a.tags?.map(s=>s)||[];o.forEach(s=>{u(s)}),o.length===0&&u(),openModal("editTaskModal")}).catch(e=>{console.error("Ошибка загрузки задачи:",e),alert("Не удалось загрузить данные задачи")})};function u(t=""){const e=document.getElementById("edit-tags-container");e.children.length;const a=document.createElement("div");a.className="flex items-center space-x-2",a.innerHTML=`
        <input type="text"
               name="tags[]"
               value="${t}"
               placeholder="Введите тег"
               class="flex-1 border rounded px-3 py-2 text-sm">
        <button type="button" class="text-red-500 text-sm remove-tag-btn">&times;</button>
    `,e.appendChild(a),a.querySelector(".remove-tag-btn").addEventListener("click",()=>{a.remove(),e.children.length===0&&u()})}document.getElementById("add-tag-btn")?.addEventListener("click",()=>{u()});document.getElementById("editTaskForm")?.addEventListener("submit",function(t){t.preventDefault();const e=document.getElementById("edit-task-id").value,a=document.getElementById("edit-task-title").value,n=document.getElementById("edit-task-description").value,o=document.getElementById("edit-task-status").value,s=document.querySelectorAll('#edit-tags-container input[name="tags[]"]'),d=Array.from(s).map(c=>c.value.trim()).filter(c=>c!==""),i={title:a,description:n,status_code:o,tags:d};fetch(`/api/tasks/${e}`,{method:"PUT",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/json"},body:JSON.stringify(i)}).then(c=>{if(c.ok)closeModal("editTaskModal");else return c.text().then(m=>{throw new Error(m)})}).catch(c=>{console.error("Ошибка обновления:",c),alert("Не удалось сохранить задачу")})});document.getElementById("createTaskForm")?.addEventListener("submit",function(t){t.preventDefault();const e={title:document.getElementById("create-task-title").value,description:document.getElementById("create-task-description").value,status:document.getElementById("create-task-status").value};fetch("/api/tasks",{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/json"},body:JSON.stringify(e)}).then(a=>a.json()).then(a=>{let n=a.data;const o=document.createElement("div");o.className="bg-gray-50 p-3 rounded border border-gray-200 task-card",o.dataset.taskId=n.id,o.dataset.status=n.status_code,o.innerHTML=`
            <h3 class="font-medium">${n.title}</h3>
            <p class="text-sm text-gray-600 mt-1">${n.description||""}</p>
            <div class="mt-2 flex space-x-2">
                <button type="button" class="text-blue-500 text-sm" onclick="openEditModal(${n.id})">
                    Редактировать
                </button>
                <button type="button" class="text-red-500 text-sm" onclick="deleteTask(${n.id})">
                    Удалить
                </button>
            </div>
        `,document.getElementById(`column-${n.status_code}`).appendChild(o),closeModal("createTaskModal"),document.getElementById("createTaskForm").reset()}).catch(()=>alert("Не удалось создать задачу"))});let l=.1;document.addEventListener("mouseover",function(t){const e=t.target.closest(".task-card");if(!e)return;const a=e.querySelector(".task-tags-tooltip");if(!a)return;const n=e.dataset.taskId;l=setTimeout(()=>{a.textContent="Загрузка...",a.classList.remove("hidden"),e.dataset.tagsLoaded||fetch(`/api/tasks/${n}`).then(o=>o.json()).then(o=>{let s=o.data;if(!s.tags||s.tags.length===0)a.textContent="Нет тегов";else{const d=s.tags.map(i=>i).join(", ");a.textContent=d}e.dataset.tagsLoaded="true"}).catch(()=>{a.textContent="Ошибка"})},300)});document.addEventListener("mouseout",function(t){l&&(clearTimeout(l),l=null);const e=t.target.closest(".task-card");if(!e)return;const a=e.querySelector(".task-tags-tooltip");a&&a.classList.add("hidden")});document.addEventListener("click",function(t){const e=t.target.closest(".task-card");if(!e||t.target.closest(".card-button"))return;const n=e.dataset.taskId;openTaskDetail(n)});window.openTaskDetail=function(t){fetch(`/api/tasks/${t}`).then(e=>e.json()).then(e=>{let a=e.data;p(a)}).catch(()=>alert("Не удалось загрузить задачу"))};function p(t){document.getElementById("detail-task-id").value=t.id,document.getElementById("detail-task-title").textContent=t.title,document.getElementById("detail-task-description").textContent=t.description||"—";const e={pending:"Ожидает",in_progress:"В работе",completed:"Завершено"};document.getElementById("detail-task-status").textContent=e[t.status_code]||t.status_code;const a=document.getElementById("detail-task-tags");a.innerHTML="",t.tags&&t.tags.length>0?t.tags.forEach(n=>{const o=document.createElement("span");o.className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded",o.textContent=n,a.appendChild(o)}):a.innerHTML='<span class="text-gray-500 text-sm">Нет тегов</span>',openModal("taskDetailModal")}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".task-card").forEach(t=>{t.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",t.dataset.taskId),t.classList.add("opacity-50")}),t.addEventListener("dragend",()=>{t.classList.remove("opacity-50")})}),document.querySelectorAll('[id^="column-body-"]').forEach(t=>{t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("bg-blue-50","border-dashed","border-2")}),t.addEventListener("dragleave",e=>{t.contains(e.relatedTarget)||t.classList.remove("bg-blue-50","border-dashed","border-2")}),t.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("bg-blue-50","border-dashed","border-2");const a=e.dataTransfer.getData("text/plain"),n=t.id.replace("column-body-",""),o=document.querySelector(`.task-card[data-task-id="${a}"]`);!o||o.dataset.status===n||g(a,n).then(d=>{o.dataset.status=n,t.appendChild(o)}).catch(d=>{console.error("Ошибка при обновлении статуса:",d),alert("Не удалось переместить задачу")})})})});async function g(t,e){try{const a=await fetch(`/api/tasks/${t}`);if(!a.ok)throw new Error("Не удалось загрузить задачу");const n=await a.json(),o=n.data||n;o.status=e;const s=await fetch(`/api/tasks/${t}`,{method:"PUT",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(o)});if(!s.ok){const i=await s.text();throw console.error("Ошибка обновления:",i),new Error("Сервер вернул ошибку при обновлении")}const d=await s.json();return d.data||d}catch(a){throw console.error("updateTaskStatus failed:",a),alert("Не удалось изменить статус задачи"),a}}
